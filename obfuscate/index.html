
<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<title>Haplotype Reconstruction</title>
<h1> test </h1>
<style>
#container {
    background-color:#F9F6F2;
	position:absolute;
	left:0px;
	top:0px;
	width:100%;
	height:100%;
}

#buttons {
	position:absolute;
	left:0px;
	top:0px;
	z-index:10;
}
</style>


</head>
<body onresize="resizeCanvas()" >
<div id="buttons" >
<input type="file" id="file_upload" onchange="processFile();" /><--- Upload ihaplo file<br />
<!-- <input type="checkbox" id="rlines" onchange="toggleRAng()"  checked=true > Rlines</input><br />
<input type="button" id="play" onclick="cutting()" > Play</input><br />
<input type="checkbox" id="map" onchange="toggleMarkerScale()" > MarkerMap</input> -->

</div>

<div id='container' ><!-- KineticJS creates a canvas for each layer, so no need --></div>

<!-- CODE GOES HERE -->
        <script src="../JS/frameworks/kinetic-v5.1.0.js" ></script>
<script>
var family_map={},marker_map={},marker_array=[];var nodeSize=10;var horiz_space=60,vert_space=50;var default_stroke_color="blue",default_font="bold 10px Courier";var grid_rezY=nodeSize*6,grid_rezX=nodeSize*2;var max_fam_width=160;var HAP_DRAW_LIM=30,HAP_MIN_DRAW=50,HAP_VERT_SPA=10;var haplomode_panel_xoffs=100;var use_right_angles=true,use_grid=true;var col_affs=["grey","white","red"];function toInt(arg){return parseInt(arg);}function assert(bool,message){if(!bool){throw new Error(message);}}function sortedKeys(mapper){return Object.keys(mapper).sort(function(a,b){return a-b;});}function map2orderedArray(mapper){var keys=sortedKeys(mapper);var ordered_array=[];for(var k=0;k<keys.length;k++){var obj=mapper[keys[k]];ordered_array.push(obj);}return ordered_array;}function isEmpty(map){return Object.getOwnPropertyNames(map).length===0;}var generation_grid_ids={},unique_graph_objs={};var maxlen_marker=0;var butt_w=90,butt_h=20;var min_haplo_x=horiz_space,max_haplo_x=horiz_space+30;var slideinp_w=20,slideinp_h=5,slider_height=innerHeight*0.5,I_slider_extension=35,I_slider_offset=(slideinp_w/3);var slider_style={R_stroke:"red",R_strokeWidth:5,R_cap:"round",I_stroke:"black",I_strokeWidth:2,I_fontFamily:"monospace",I_fontSize:10,I_fontColor:"black"};var in2Space=function(integ){var tx="";while(integ-->0){tx+=" ";}return tx;};var haploblock_settings={space_pixels:6,marker_offset:1,ht_offset:7,ht_2_ht:1};var haploblock_buffers={marker_offset:in2Space(haploblock_settings.marker_offset),ht_offset:in2Space(haploblock_settings.ht_offset),ht_2_ht:in2Space(haploblock_settings.ht_2_ht)};var haploblock_spacers={marker_offset_px:((maxlen_marker+11)*haploblock_settings.space_pixels)+1,person_offset_px:10*haploblock_settings.space_pixels,block_width_px:HAP_VERT_SPA*1.2,block_offset_px:(HAP_VERT_SPA*1.2)+2};var SEXLINKED=false,DOMINANT=true;var MALE=1,FEMALE=2,UNAFFECTED=1,AFFECTED=2;var Person=function(id,gender,affected,mother,father){this.id=id;this.gender=gender;this.affected=affected;this.mother=mother;this.father=father;this.haplo_data=[];this.mates=[];this.children=[];};Person.prototype.isMate=function(pers2){for(var m=0;m<this.mates.length;m++){if(pers2.id==this.mates[m].id){return true;}}return false;};Person.prototype.isChild=function(pers2){for(var c=0;c<this.children.length;c++){if(pers2.id==this.children[c].id){return true;}}return false;};Person.prototype.isFounder=function(){return(this.mother===0&&this.father===0);};function connectAllIndividuals(){for(var famid in family_map){for(var id in family_map[famid]){var new_root=family_map[famid][id];var pers_father=0,pers_mother=0;if(new_root.father!=0){pers_father=family_map[famid][new_root.father];new_root.father=pers_father;pers_father.children.push(new_root);}if(new_root.mother!=0){pers_mother=family_map[famid][new_root.mother];new_root.mother=pers_mother;pers_mother.children.push(new_root);}if(pers_father!=0){if(pers_mother!=0){pers_father.mates.push(pers_mother);}else{pers_father.mates.push(0);}}if(pers_mother!=0){if(pers_father!=0){pers_mother.mates.push(pers_father);}else{pers_mother.mates.push(0);}}}}}function determinePedigreeType(){var ped_id=(function largestPedigree(){var max_memb=0,max_fam=0;for(var fid in generation_grid_ids){var num_memb=0;for(var g=0;g<generation_grid_ids[fid].length;g++){num_memb+=generation_grid_ids[fid][g].length;}if(num_memb>max_memb){max_memb=num_memb;max_fam=fid;}}return max_fam;})();SEXLINKED=function singleAlleleMale(){var all_zero_Ychroms=0;var num_males_checked=0;var num_males_with_single_allele=0;for(var g=0;g<generation_grid_ids[ped_id].length;g++){for(var p=0;p<generation_grid_ids[ped_id][g].length;p++){var perc_id=generation_grid_ids[ped_id][g][p],perc=family_map[ped_id][perc_id];if(perc.gender==MALE){if(perc.haplo_data.length==1){num_males_with_single_allele++;}else{var num_all_zero_alleles=0;for(var a=0;a<perc.haplo_data.length;a++){var all_zeroes=true;for(var i=0;i<perc.haplo_data[a].data_array.length;i++){if(perc.haplo_data[a].data_array[i]!==0){all_zeroes=false;break;}}if(all_zeroes){num_all_zero_alleles++;}}if(num_all_zero_alleles===2){continue;}all_zero_Ychroms+=num_all_zero_alleles;}num_males_checked++;}}}if(num_males_with_single_allele===num_males_checked){return true;}if(all_zero_Ychroms===num_males_checked){return true;}if(num_males_with_single_allele+all_zero_Ychroms===num_males_checked){return true;}return false;}();DOMINANT=function checkAffectedsInGens(){var affected_in_each_gen=0,num_gens=generation_grid_ids[ped_id].length;for(var g=0;g<generation_grid_ids[ped_id].length;g++){var affecteds_in_gen=0;for(var p=0;p<generation_grid_ids[ped_id][g].length;p++){var perc_id=generation_grid_ids[ped_id][g][p],perc=family_map[ped_id][perc_id];if(perc.affected===AFFECTED){affecteds_in_gen++;}}if(affecteds_in_gen>0){affected_in_each_gen++;}}return affected_in_each_gen===num_gens;}();console.log("sexlinked=",SEXLINKED);console.log("dominant=",DOMINANT);if(SEXLINKED){(function addZeroAllele_for_sexlinkedMales(){for(var fid in generation_grid_ids){for(var gen=0;gen<generation_grid_ids[fid].length;gen++){for(var mem=0;mem<generation_grid_ids[fid][gen].length;mem++){var perc_id=generation_grid_ids[fid][gen][mem],perc=family_map[fid][perc_id];if(perc.gender===MALE&&perc.haplo_data.length===1){var len_of_allele=perc.haplo_data[0].data_array.length,new_allele=[];for(var i=0;i<len_of_allele;i++){new_allele.push(0);}perc.haplo_data.push(new Allele(new_allele));}}}}})();}}var stage=new Kinetic.Stage({container:"container",width:window.innerWidth,height:window.innerHeight});var main_layer=new Kinetic.Layer({id:"main"}),haplo_layer=new Kinetic.Layer({id:"haplo"});var mscale_layer=new Kinetic.Layer({id:"marker_scale",x:0,y:0,width:100,height:slider_height+20});function addSquare(color){return new Kinetic.Rect({x:-nodeSize,y:-nodeSize,width:nodeSize*2,height:nodeSize*2,fill:color,strokeWidth:2,stroke:default_stroke_color});}function addCircle(color){return new Kinetic.Circle({x:0,y:0,radius:nodeSize,fill:color,strokeWidth:2,stroke:default_stroke_color});}function addDiamond(color){alert("fix lucy");}function changeRLine(line,start,end,offset_y){offset_y=offset_y||0;if(!use_right_angles){line.setPoints([start.x,start.y,end.x,end.y]);}else{var mid_y=Math.floor((start.y+end.y)/2),m1={x:start.x,y:(mid_y+offset_y)},m2={x:end.x,y:(mid_y+offset_y)};line.setPoints([start.x,start.y,m1.x,m1.y,m2.x,m2.y,end.x,end.y]);}}var overlapping_lines={};function linesConflictY(st,en,ypos){var margin=1;for(var y=ypos-margin;y<ypos;y++){if(y in overlapping_lines){return true;}}for(var y=ypos-5;y<ypos+5;y++){overlapping_lines[y]=true;}return false;}function addRLine_nonoverlapY(start,end,consang){var offy=0;while(linesConflictY(start,end,offy)){offy-=1;}return addRLine_simple(start,end,consang,offy);}function addRLine_simple(start,end,consang,offset_y){offset_y=offset_y||0;var line=new Kinetic.Line({stroke:"black",strokeWidth:2});if(consang){line.attrs.shadowColor="black";line.attrs.shadowBlur=0;line.attrs.shadowOffsetY=-nodeSize/3;line.attrs.shadowOpacity=1;}changeRLine(line,start,end,offset_y);return line;}function addRLine(fam_group,start,end,consang){var line=addRLine_simple(start,end,consang);fam_group.add(line);return line;}function finishDraw(){stage.add(main_layer);stage.add(haplo_layer);stage.add(mscale_layer);}function addFamily(fam_id,sx,sy){var g=new Kinetic.Group({x:sx,y:sy,draggable:true,id:fam_id});var t=new Kinetic.Text({x:50,text:fam_id,fontFamily:"Arial",fontSize:18,fill:"black"});g.add(t);g.on("dblclick",function(){selectFam(fam_id);g.moveToTop();});t.on("mouseover",function(){t.setFill("red");main_layer.draw();});t.on("mousedown",function(){g.setScale({x:0.95,y:0.95});});t.on("mouseout mouseup",function(){g.setScale({x:1,y:1});t.setFill("black");main_layer.draw();});main_layer.add(g);return g;}function addHaploBlocksAll(){var grp=new Kinetic.Group({x:-50,y:((2*nodeSize)+10)});var haplo=new Kinetic.Group({});for(var q=0;q<haploinfos.length;q++){for(var j=0;j<2;j++){var one_hgroup=haploinfos[q][j].haplogroup_array;var ind=sta_index;while(ind<=end_index){var iter=ind,color_group=one_hgroup[iter];while(one_hgroup[++iter]===color_group&&iter<=end_index){}var rec=new Kinetic.Rect({x:haploblock_spacers.marker_offset_px+((q*haploblock_spacers.person_offset_px)+(j*haploblock_spacers.block_offset_px)),y:((ind-sta_index-2)*HAP_VERT_SPA),width:haploblock_spacers.block_width_px,height:(iter-ind)*HAP_VERT_SPA,fill:unique_colors[color_group],strokeWidth:1,stroke:"white"});haplo.add(rec);ind=iter;}}}grp.add(haplo);var total_text="";for(var m=sta_index;m<=end_index;m++){total_text+=marker_array[m]+haploblock_buffers.marker_offset;for(var i=0;i<haploinfos.length;i++){total_text+=(haploblock_buffers.ht_offset+haploinfos[i][0].data_array[m]+haploblock_buffers.ht_2_ht+haploinfos[i][1].data_array[m]);}total_text+="\n";}var text=new Kinetic.Text({x:-38,y:-nodeSize*2,text:total_text,fontFamily:slider_style.I_fontFamily,fontSize:10,fill:"black"});grp.add(text);return grp;}function addPerson(person,fam_group,t_x,t_y){var gender=person.gender,id=person.id,aff=person.affected;var makeshape=function pedigreeShape(){var shape=0;function addMale(){shape=addSquare(col_affs[aff]);}function addFemale(){shape=addCircle(col_affs[aff]);}function addAmbig(){shape=addDiamond(col_affs[aff]);}switch(gender){case 0:addAmbig();break;case 1:addMale();break;case 2:addFemale();break;default:assert(false,"No gender for index "+gender);}return shape;};var label=new Kinetic.Group({x:-(""+id+"").length*3,y:nodeSize+10});label.add(new Kinetic.Rect({fill:"white",opacity:0.8,y:-nodeSize/2,width:(""+id+"").length*6,height:8}));label.add(new Kinetic.Text({text:id,fontSize:"Calibri",fill:default_stroke_color}));var group=new Kinetic.Group({x:t_x,y:t_y,draggable:true});group.add(makeshape()).add(label);group.on("dragmove",function(e){if(use_grid){var x=e.target.attrs.x;var y=e.target.attrs.y;group.setX((Math.floor(x/grid_rezX)*grid_rezX));group.setY((Math.floor(y/grid_rezY)*grid_rezY));}redrawNodes(id,fam_group.attrs.id,true);});fam_group.add(group);return group;}function addWhiteRect(props){props.fill="white";props.stroke="black";props.strokeWidth=2;props.cornerRadius=10;return new Kinetic.Rect(props);}function kineticTween(props){props.easing=Kinetic.Easings.EaseIn;props.duration=0.8;return new Kinetic.Tween(props);}function addButton(message,xp,yp,callback,show_state){var group=new Kinetic.Group({x:xp,y:yp});var rec=new Kinetic.Rect({x:0,y:0,width:butt_w,height:butt_h,fill:"grey",stroke:"black",strokeWidth:2,cornerRadius:6});var tex=new Kinetic.Text({x:6,y:butt_h/4,text:message,fontSize:10,fill:"white"});group.add(rec);group.add(tex);if(show_state){var diam=8,buff=4;var status=new Kinetic.Rect({x:butt_w-diam,y:buff,width:diam-buff,height:diam-buff,fill:"red"});group.add(status);var butt_state=true;group.on("click",function(){status.setFill(butt_state?"green":"red");butt_state=!butt_state;});}group.on("click",callback);return group;}function addExitButton(center,callback){var cross_diam=20,cross_rad=cross_diam/2;var rect=new Kinetic.Rect({x:-cross_rad,y:-cross_rad,width:cross_diam,height:cross_diam,fill:"grey",stroke:"black",strokeWidth:1.5,cornerRadius:3});var crossUp=new Kinetic.Line({stroke:"white",strokeWidth:1});var crossDown=new Kinetic.Line({stroke:"white",strokeWidth:1});var cross_buff=cross_rad-5;crossUp.setPoints([-cross_buff,-cross_buff,cross_buff,cross_buff]);crossDown.setPoints([-cross_buff,cross_buff,cross_buff,-cross_buff]);var group=new Kinetic.Group({x:center.x,y:center.y});group.on("click",callback);group.add(rect);group.add(crossUp);group.add(crossDown);return group;}function redrawNodes(pers_id,fam_id,drawLinesToo){var pers=family_map[fam_id][pers_id],node_map=unique_graph_objs[fam_id].nodes,edge_map=unique_graph_objs[fam_id].edges,npers=node_map[pers_id],npers_pos=npers.graphics.getPosition(),per_isMale=(pers.gender==1);for(var m=0;m<pers.mates.length;m++){var mate=pers.mates[m],nmate=node_map[mate.id].graphics,nmate_pos=nmate.getPosition();nmate.setY(npers_pos.y);var ch_x=npers_pos.x+(nodeSize*2);if(ch_x>nmate_pos.x){if((ch_x-nmate_pos.x)<horiz_space){nmate.setX(ch_x-horiz_space);}}for(var mm=0;mm<mate.mates.length;mm++){var matemate_id=mate.mates[mm].id;if(matemate_id!=pers_id){var nmatemate=node_map[matemate_id].graphics,nmatemate_pos=nmatemate.getPosition();nmatemate.setY(npers_pos.y);}}if(drawLinesToo){var male_id=(per_isMale)?pers.id:mate.id,female_id=(per_isMale)?mate.id:pers.id;var mateline_id=UUID("m",male_id,female_id),mateline=edge_map[mateline_id].graphics;var s1_x=npers_pos.x,s1_y=npers_pos.y,e1_x=nmate_pos.x,e1_y=nmate_pos.y;changeRLine(mateline,npers_pos,nmate_pos);var childkey_starting="c:"+mateline_id;for(var key in unique_graph_objs[fam_id].edges){if(key.lastIndexOf(childkey_starting,0)===0){var find_child_id=key.split("-"),child_id=toInt(find_child_id[find_child_id.length-1].trim()),nchild=node_map[child_id].graphics.getPosition();var s3_x=Math.floor((s1_x+e1_x)/2),s3_y=s1_y;changeRLine(edge_map[key].graphics,{x:s3_x,y:s3_y},nchild);}}if(mate.father!=0){var mates_mateline_id=UUID("m",mate.father.id,mate.mother.id),mates_childline_id=UUID("c",mates_mateline_id,mate.id),m_po=edge_map[mates_mateline_id].graphics.getPoints();var sm_x=Math.floor((m_po[0]+m_po[m_po.length-2])/2),sm_y=m_po[m_po.length-1];changeRLine(edge_map[mates_childline_id].graphics,{x:sm_x,y:sm_y},nmate_pos);}}}var last_gen=generation_grid_ids[fam_id][generation_grid_ids[fam_id].length-1];if(last_gen.indexOf(pers_id)!==-1){for(var c=0;c<last_gen.length;c++){var sib_id=last_gen[c],n_sib=unique_graph_objs[fam_id].nodes[sib_id].graphics;n_sib.setY(npers_pos.y);if(drawLinesToo){var sib_pers=family_map[fam_id][sib_id],sib_moth=sib_pers.mother.id,sib_fath=sib_pers.father.id;var m_id=UUID("m",sib_fath,sib_moth),m_points=edge_map[m_id].graphics.getPoints();var c_id=UUID("c",m_id,sib_id);var sm_x=Math.floor((m_points[0]+m_points[m_points.length-2])/2),sm_y=m_points[m_points.length-1];changeRLine(edge_map[c_id].graphics,{x:sm_x,y:sm_y},n_sib.getPosition());}}}if(drawLinesToo&&(pers.father!=0&&pers.mother!=0)){var childline_id=UUID("c",UUID("m",pers.father.id,pers.mother.id),pers_id),childline=edge_map[childline_id],childline_ps=childline.graphics.getPoints();var s4_x=childline_ps[0],s4_y=childline_ps[1];changeRLine(childline.graphics,{x:s4_x,y:s4_y},npers_pos);}}function touchlines(grid_use){use_grid=grid_use;for(var one in family_map){for(var two in family_map[one]){var e=new CustomEvent("dragmove",{target:{attrs:{x:10,y:10}}}),o=unique_graph_objs[one].nodes[two].graphics;o.dispatchEvent(e);}}use_grid=true;}function spaceFamGroups(){var leftover_gap=window.innerWidth,num_fams=0;var global_minx=9999999;for(var fid in family_map){num_fams++;var nodes=unique_graph_objs[fid].nodes;var min_x=9999999,max_x=0;for(var nid in nodes){if(nid==="0"){continue;}var xer=nodes[nid].graphics.getX();if(min_x>xer){min_x=xer;}if(max_x<xer){max_x=xer;}}if(global_minx>min_x){global_minx=min_x;}leftover_gap-=max_x-min_x;}var buffer_x=nodeSize*4;leftover_gap-=(buffer_x*2);if(global_minx<0){buffer_x-=global_minx;leftover_gap-=global_minx;}var gap_between=Math.floor(leftover_gap/(num_fams));if(gap_between>0){var step=buffer_x;for(var fid in family_map){var group=unique_graph_objs[fid].group;group.setX(group.getX()+step);step+=gap_between;}}}function linesShow(fid,show){var edges=unique_graph_objs[fid].edges;for(var eid in edges){if(show){edges[eid].graphics.show();edges[eid].graphics.setZIndex(-21);}else{edges[eid].graphics.hide();}}main_layer.draw();}function UUID(type,from_id,to_id){return type+":"+from_id+"-"+to_id;}function populateGrids_and_UniqueObjs(){function addFamMap(root){var generation_gridmap_ids={},unique_nodes_fam={0:{graphics:null}},unique_edges_fam={};function incrementNodes(id){if(!(id in unique_nodes_fam)){unique_nodes_fam[id]={graphics:null,count:0};}unique_nodes_fam[id].count+=1;}function incrementEdges(id,start_join,end_join,typer){if(!(id in unique_edges_fam)){unique_edges_fam[id]={graphics:null,count:0,type:typer,start_join_id:start_join,end_join_id:end_join,double_line:false};}unique_edges_fam[id].count+=1;}function addTrioEdges(moth,fath,child){var u_matesline=UUID("m",fath.id,moth.id),u_childline=UUID("c",u_matesline,child.id);incrementEdges(u_matesline,fath.id,moth.id,0);incrementEdges(u_childline,u_matesline,child.id,2);incrementNodes(moth.id);incrementNodes(fath.id);incrementNodes(child.id);}function intersect_safe(a,b){var ai=0,bi=0;var result=new Array();while(ai<a.length&&bi<b.length){if(a[ai].id<b[bi].id){ai++;}else{if(a[ai].id>b[bi].id){bi++;}else{result.push(a[ai]);ai++;bi++;}}}return result;}function addNodeArray(obj_pers,level){if(obj_pers.id in unique_nodes_fam){return;}incrementNodes(obj_pers.id);if(!(level in generation_gridmap_ids)){generation_gridmap_ids[level]=[];}generation_gridmap_ids[level].push(obj_pers.id);for(var m=0;m<obj_pers.mates.length;m++){addNodeArray(obj_pers.mates[m],level);var shared_childs=intersect_safe(obj_pers.children,obj_pers.mates[m].children);for(var c=0;c<shared_childs.length;c++){addNodeArray(shared_childs[c],level+1);}}if(obj_pers.mother!=0){addNodeArray(obj_pers.mother,level-1);}if(obj_pers.father!=0){addNodeArray(obj_pers.father,level-1);}if(obj_pers.mother!=0&&obj_pers.father!=0){addTrioEdges(obj_pers.mother,obj_pers.father,obj_pers);}return;}addNodeArray(root,0);var generation_grid_ids_fam=map2orderedArray(generation_gridmap_ids);var uniq_map={nodes:unique_nodes_fam,edges:unique_edges_fam};return[generation_grid_ids_fam,uniq_map];}for(var one in family_map){for(var two in family_map[one]){var root=family_map[one][two];var arr_obj=addFamMap(root);var generation_array=arr_obj[0],uniq_objs=arr_obj[1];unique_graph_objs[one]=uniq_objs;generation_grid_ids[one]=generation_array;for(var g=0;g<generation_array;g++){for(var i=0;i<generation_array[g];i++){}}break;}}}function graphInitPos(start_x,start_y){var x_shift_fam=0;for(var fam in generation_grid_ids){var fam_group=addFamily(fam,x_shift_fam,10);var max_x=0;var y_pos=start_y,gen_grid=generation_grid_ids[fam],nodes=unique_graph_objs[fam].nodes,edges=unique_graph_objs[fam].edges;unique_graph_objs[fam].group=fam_group;for(var gen=0;gen<gen_grid.length;gen++){var x_pos=start_x;var num_peeps=gen_grid[gen].length,isOddNum=!((num_peeps%2)==0),center_x=Math.floor(max_fam_width/2);function placePerp(index,posx){var perp_id=gen_grid[gen][index],perp=family_map[fam][perp_id],n_perp=nodes[perp_id];n_perp.graphics=addPerson(perp,fam_group,posx,y_pos);if(posx>max_x){max_x=posx;}}var start1,start2;if(isOddNum){var center_ind=Math.floor(num_peeps/2);placePerp(center_ind,center_x);var tmp1=center_ind,tmp2=center_ind;start1=center_x,start2=center_x;while(tmp1>0){placePerp(--tmp1,start1-=horiz_space);placePerp(++tmp2,start2+=horiz_space);}}else{var center2_ind=(num_peeps/2),center1_ind=center2_ind-1;var tmp1=center2_ind,tmp2=center1_ind;start1=center_x+Math.floor(horiz_space/2);start2=center_x-Math.floor(horiz_space/2);while(tmp1>0){placePerp(--tmp1,start1-=horiz_space);placePerp(++tmp2,start2+=horiz_space);}}y_pos+=vert_space+25;}for(var tp=0;tp<=2;tp++){for(var key in edges){var edge=edges[key],type=edge.type,end_join_id=edge.end_join_id,start_join_id=edge.start_join_id;if(type!==tp){continue;}var start_pos,end_pos,consang=false;if(type===0){start_pos=nodes[start_join_id].graphics.getPosition();end_pos=nodes[end_join_id].graphics.getPosition();consang=checkConsanginuity(fam,start_join_id,end_join_id);}else{if(type===2){var mateline_points=edges[start_join_id].graphics.getPoints(),child_pos=nodes[end_join_id].graphics.getPosition();start_pos={x:Math.floor((mateline_points[0]+mateline_points[2])/2),y:mateline_points[1]};end_pos={x:child_pos.x,y:child_pos.y};}else{assert(false,"Wrong type! "+key+", type= "+type);}}edge.graphics=addRLine(fam_group,start_pos,end_pos,consang);edge.consangineous=consang;edge.graphics.moveToBottom();}}x_shift_fam+=max_x+20;}finishDraw();touchlines();spaceFamGroups();main_layer.draw();}function checkConsanginuity(fam_id,pers1_id,pers2_id){var fam_map=family_map[fam_id],pers1=fam_map[pers1_id],pers2=fam_map[pers2_id];var routes2=[];routes2.push(pers1);routes2.push(pers2);var complete=[],loopnum=0;while(routes2.length>0&&loopnum++<100){var perc=routes2.shift();if(perc.mother===0&&perc.father===0){complete.push(perc.id);continue;}if(perc.mother!=0){routes2.push(perc.mother);}if(perc.father!=0){routes2.push(perc.father);}}complete=complete.sort();for(var a=0;a<complete.length-1;a++){if(complete[a+1]===complete[a]){return true;}}return false;}var bhaplox_offset=-5,bhaploy_offset=0;function addHMButton(message,callback){var b=addButton(message,bhaplox_offset,bhaploy_offset,callback);bhaploy_offset+=butt_h+5;return b;}function resetHMButtons(){bhaplox_offset=-5;bhaploy_offset=0;}function addHaploScreen(wi,he,haplofam_map){var ped_group=new Kinetic.Group();var bg=new Kinetic.Rect({x:+nodeSize*2,y:-nodeSize,width:wi-nodeSize*2,height:he+nodeSize,fill:"white",stroke:"black",strokeWidth:2});var align_button=addHMButton("Align",function(){toggle_horizAlign(haplofam_map);});var haplo_button=addHMButton("Haplo",function(){toggle_haplotypes(haplofam_map);});var zoom_button=addHMButton("Zoom",function(){toggle_zoomer();});ped_group.add(bg);ped_group.add(align_button);ped_group.add(haplo_button);ped_group.add(zoom_button);ped_group.zoomer=zoom_button;zoom_button.hide();resetHMButtons();var scroll_window=new Kinetic.Group({x:-nodeSize*2,y:he+nodeSize*2,id:"scroll_panel",draggable:false});var scroll_area__=new Kinetic.Group({draggable:true,dragBoundFunc:function(pos){var group_loc=this.parent.getAbsolutePosition();return{x:group_loc.x,y:group_loc.y+(Math.floor((pos.y-group_loc.y)/HAP_VERT_SPA)*HAP_VERT_SPA)};}});scroll_area__.on("mouseup",function(){redrawHaplos();updateInputsByIndex(sta_index,end_index);updateSlide();mscale_layer.draw();});var main_rect=new Kinetic.Rect({x:-butt_w,y:0,width:wi+butt_w,height:((HAP_DRAW_LIM+1)*HAP_VERT_SPA)+nodeSize*2,fill:"white",stroke:"black",strokeWidth:2});scroll_window.add(main_rect);scroll_window.add(scroll_area__);scroll_window.hide();var total_group=new Kinetic.Group();total_group.add(ped_group);total_group.add(scroll_window);scroll_window.background=main_rect;total_group.main_box=scroll_window;total_group.scrollable=scroll_area__;ped_group.background=bg;total_group.ped_grp=ped_group;total_group.move({x:haplomode_panel_xoffs,y:0});return total_group;}var start_positionx_haplomode=butt_w+nodeSize+haplomode_panel_xoffs;var transition_happening=false;function transitionToggle(haplofam_map,toggler,lineswitch,use_y,groupmove,onfinishfunc,draggable){var start_x=start_positionx_haplomode,start_y=use_y?0:nodeSize*2;var spacingx=min_haplo_x,spacingy=5;function main_to_haplo(){for(var fam_id in haplofam_map){var gen_lines=generation_grid_ids[fam_id],n_caa=unique_graph_objs[fam_id],fam_o_interest=haplofam_map[fam_id],all_selected=fam_o_interest.all_selected;if(all_selected){n_caa.group.remove();haplo_layer.add(n_caa.group);}else{var new_haplogroup=new Kinetic.Group({name:fam_id});for(var id in fam_o_interest){var n_chl=n_caa.nodes[id],gfx=n_chl.graphics;n_chl.mainlayer_pos=gfx.getPosition();gfx.remove();new_haplogroup.add(gfx);}haplo_layer.add(new_haplogroup);}}main_layer.draw();haplo_layer.draw();if(!all_selected){for(var fam_id in haplofam_map){var subgrid_map={},working_map=generation_grid_ids[fam_id];}}}linesShow(fam_id,false);for(var g=0;g<gen_lines.length;g++){var incremental_y=0;if(use_y){incremental_y=(gen_lines[g].length+1)*spacingy;}for(var c=0;c<gen_lines[g].length;c++){var ch_id=gen_lines[g][c],n_chl=n_caa.nodes[ch_id],gfx=n_chl.graphics;n_chl.start_pos=n_chl.start_pos||[];var pos_loc=n_chl.start_pos,pos_pos;if(toggler){pos_loc.push(gfx.getPosition());}else{pos_pos=pos_loc.pop();}gfx.setDraggable(draggable);gfx.setZIndex(-20);var tween=new Kinetic.Tween({node:gfx,x:toggler?start_x:pos_pos.x,y:toggler?start_y+incremental_y:pos_pos.y,duration:0.8,easing:Kinetic.Easings.EaseIn});tween.play();start_x+=spacingx;if(use_y){incremental_y-=spacingy;}}if(use_y){start_y+=(nodeSize*2)+6+spacingy+incremental_y;}}return{x:start_x,y:start_y};}var toggle_haplo=false,toggle_horiz=false,toggle_haplobutton=false,toggle_zoommarkers=false,transition_happening=false,backg;function toggle_haplomode(haplofam_map){if(transition_happening){return;}if(toggle_horiz){toggle_horizAlign(haplofam_map);}if(toggle_haplobutton){toggle_haplotypes(haplofam_map);}if(toggle_zoommarkers){toggle_zoomer();}toggle_haplo=!toggle_haplo;var n_caa=unique_graph_objs,grp=unique_graph_objs[haplofam_map].group;if(toggle_haplo){backg=new Kinetic.Rect({x:0,y:0,width:window.innerWidth,height:window.innerHeight,fill:"black",opacity:0.5});haplo_layer.add(backg);backg.setZIndex(-98);var final_pos=transitionToggle(haplofam_map,toggle_haplo,lineswitch=true,use_y=true,groupmove=true,onfinishfunc=0,draggable=!toggle_haplo);var panel_a_scroll=addHaploScreen(final_pos.x,final_pos.y);n_caa.haplo_panel=panel_a_scroll;n_caa.haplo_scroll=panel_a_scroll.main_box;n_caa.haplo_area=panel_a_scroll.scrollable;n_caa.haplo_pedgrp=panel_a_scroll.ped_grp;n_caa.haplo_pedbg=panel_a_scroll.ped_grp.background;n_caa.haplo_panel.setZIndex(-99);}else{backg.destroy();n_caa.haplo_panel.remove();n_caa.haplo_panel.destroy();transitionToggle(haplofam_map,toggle_haplo,lineswitch=true,use_y=true,groupmove=true,onfinishfunc=0);}}function toggle_horizAlign(haplofam_map){if(transition_happening){return;}toggle_horiz=!toggle_horiz;transitionToggle(haplofam_map,toggle_horiz,lineswitch=!toggle_horiz,use_y=false,groupmove=false,onfinishfunc=0,draggable=false);var end_y=(function boxlim(){var min_y=nodeSize*8;if(toggle_horiz){return min_y;}else{return min_y+((nodeSize*2)+5)*10;}})();(new Kinetic.Tween({node:unique_graph_objs.haplo_pedbg,height:end_y,duration:1})).play();(new Kinetic.Tween({node:unique_graph_objs.haplo_scroll,y:end_y,duration:1})).play();}function toggle_haplotypes(haplofam_map){if(transition_happening){return;}toggle_haplobutton=!toggle_haplobutton;var scroll_panel_grp=unique_graph_objs.haplo_area,zoom_button=unique_graph_objs.haplo_pedgrp.zoomer;if(toggle_haplobutton){addHaplosAnyone(haplofam_map);scroll_panel_grp.parent.show();zoom_button.show();}else{scroll_panel_grp.destroyChildren();scroll_panel_grp.parent.hide();zoom_button.hide();}haplo_layer.draw();}function toggle_zoomer(){if(transition_happening){return;}toggle_zoommarkers=!toggle_zoommarkers;var marker_slid=getSlider(20,50);if(toggle_zoommarkers){mscale_layer.add(marker_slid);stage.add(mscale_layer);updateInputsByIndex(0,HAP_DRAW_LIM);updateSlide();}else{mscale_layer.destroyChildren();stage.remove(mscale_layer);}mscale_layer.draw();}function findDOSinSelection(selection_map){var selection_map_map={};for(var fam in selection_map){selection_map_map[fam]={};for(var g=0;g<selection_map[fam].length;g++){for(var i=0;i<selection_map[fam][g].length;i++){var indiv_id=selection_map[fam][g][i];selection_map_map[fam][indiv_id]=1;}}}var fam_lines={};for(var fam in selection_map){var num_diff_gens=selection_map[fam].length-1;var sib_map={};for(var g=num_diff_gens;g>=0;g--){var current_gen=selection_map[fam][g];var sib_groups={};for(var i1=0;i1<current_gen.length;i1++){var id=current_gen[i1],perc=family_map[fam][id];var fm_key;if(perc.father!==0){fm_key=perc.father.id+"_"+perc.mother.id;}else{fm_key=perc.id;}sib_groups[fm_key]=sib_groups[fm_key]||[];sib_groups[fm_key].push(perc);}for(var sgr in sib_groups){var perc=sib_groups[sgr][0];var root=perc;var matelines={},directlines={};var search=function recurseParents(root,level){if(root===0){return -1;}if(root.id!==perc.id){if(root.id in selection_map_map[fam]){return{id:root.id,dos:level};}}var moth_rez=recurseParents(root.mother,level+1),fath_rez=recurseParents(root.father,level+1);if(moth_rez!==-1&&fath_rez!==-1){var are_mates=false;if(moth_rez.dos===fath_rez.dos){var moth_perc=family_map[fam][moth_rez.id];for(var m=0;m<moth_perc.mates.length;m++){if(fath_rez.id===moth_perc.mates[m].id){are_mates=true;break;}}}if(are_mates){matelines[fath_rez.id+"_"+moth_rez.id]=moth_rez.dos;}else{var link_found=false;var lower_dos_obj,higher_dos_obj;if(moth_rez.dos<fath_rez.dos){lower_dos_obj=moth_rez;higher_dos_obj=fath_rez;}else{lower_dos_obj=fath_rez;higher_dos_obj=moth_rez;}if(!link_found){directlines[moth_rez.id]=moth_rez.dos;directlines[fath_rez.id]=fath_rez.dos;}}}else{if(moth_rez!==-1){directlines[moth_rez.id]=moth_rez.dos;}else{if(fath_rez!==-1){directlines[fath_rez.id]=fath_rez.dos;}}}return -1;};search(root,0);if(!(g in sib_map)){sib_map[g]={};}var sib_key=sib_groups[sgr][0].id;if(!(sib_groups[sgr].length===1)){for(var i=1;i<sib_groups[sgr].length;i++){sib_key+="_"+sib_groups[sgr][i].id;}}sib_map[g][sib_key]={matelines:matelines,directlines:directlines};}var sib_map2=[];for(var k in sib_map){var empty=true;for(var kk in sib_map[k]){if(!(isEmpty(sib_map[k][kk]))){empty=false;break;}}if(!empty){sib_map2.push(sib_map[k]);}}fam_lines[fam]=sib_map2;}}return fam_lines;}var initial_group_node_offset={x:100,y:40};var haplo_group_nodes=new Kinetic.Group();var haplo_group_lines=new Kinetic.Group();function render(line_points,slot_array,finishfunc){var min_pos={x:9999,y:9999},max_pos={x:0,y:0};var render_group=new Kinetic.Group();var tween_nodes=[];render_group.add(haplo_group_lines);render_group.add(haplo_group_nodes);haplo_layer.add(render_group);var start_x=20;min_pos.x=start_x;var render_counter=slot_array.length-1;for(var fd=0;fd<slot_array.length;fd++){var fid_id=slot_array[fd][0].split("_"),y_pos=slot_array[fd][1];if(min_pos.y>y_pos){min_pos.y=y_pos;}var fid=fid_id[0],id=fid_id[1];var gfx=unique_graph_objs[fid].nodes[id].graphics;gfx.main_layer_pos=gfx.getPosition();gfx.main_layer_group=unique_graph_objs[fid].group;gfx.remove();haplo_group_nodes.add(gfx);gfx.setPosition({x:gfx.main_layer_group.getX()+gfx.main_layer_pos.x,y:gfx.main_layer_group.getY()+gfx.main_layer_pos.y});var tween=kineticTween({node:gfx,x:start_x+initial_group_node_offset.x,y:y_pos+initial_group_node_offset.y,onFinish:function(){if(render_counter--===0){mapLines(line_points,haplo_group_lines);finishfunc(render_group);}}});tween_nodes.push(tween);start_x+=horiz_space;if(start_x>max_pos.x){max_pos.x=start_x;}if(y_pos>max_pos.y){max_pos.y=y_pos;}}main_layer.draw();for(var t=0;t<tween_nodes.length;){tween_nodes[t++].play();}return{min:min_pos,max:max_pos,group:render_group};}function mapLinesAndNodes(line_map){var slot_array=[];function sortXHaplo(pos_y,id,fid){var key=fid+"_"+id;for(var k=0;k<slot_array.length;k++){if(key===slot_array[k][0]){slot_array.splice(k,1);break;}}slot_array.push([key,pos_y]);}var line_points={};var end_point_nodes_drawn={};function addLinePoint(fid,key,obj){if(key in line_points[fid]){var eski_obj=line_points[fid][key],eski_dos=eski_obj.dos;if(obj.dos<eski_dos){line_points[fid][key]=obj;}}else{line_points[fid][key]=obj;}}for(var fid in line_map){var start_y=0;var drop_amount=50;line_points[fid]={};var back_step=10;for(var g=0;g<line_map[fid].length;g++){for(var sgroup in line_map[fid][g]){var directline=line_map[fid][g][sgroup].directlines,mateline=line_map[fid][g][sgroup].matelines;for(var mline in mateline){var parents=mline.split("_"),fath_id=parents[0],moth_id=parents[1];sortXHaplo(start_y,fath_id,fid);sortXHaplo(start_y,moth_id,fid);var consang=unique_graph_objs[fid].edges["m:"+fath_id+"-"+moth_id].consangineous;addLinePoint(fid,fath_id,{to:moth_id,consang:consang,drop:null,text:null,lastgen:(g==line_map[fid].length-1)});var dos=mateline[mline];addLinePoint(fid,fath_id+"_"+moth_id,{to:sgroup,consang:false,drop:drop_amount,text:dos,lastgen:(g==line_map[fid].length-1)});}for(var dline in directline){var found_existing_mateline=false;var linep_keys=Object.keys(line_points[fid]);for(var kk=0;kk<linep_keys.length;kk++){var key_ids=linep_keys[kk].split("_");if(key_ids.length!=2){key_ids=[key_ids];}for(var ik=0;ik<key_ids.length;ik++){if(dline===key_ids[ik]){found_existing_mateline=true;break;}}if(found_existing_mateline){break;}}if(!(found_existing_mateline)){start_y+=drop_amount;sortXHaplo(start_y,dline,fid);var dos=directline[dline];addLinePoint(fid,dline,{to:sgroup,consang:false,drop:drop_amount,text:dos,lastgen:(g==line_map[fid].length-1)});}}var sib_ids=sgroup.split("_");var sib_stepper=(start_y+drop_amount);for(var s=0;s<sib_ids.length;s++){sortXHaplo(sib_stepper,sib_ids[s],fid);}}}}return{lp:line_points,sa:slot_array};}function mapLines(line_points,haplo_group_lines){for(var fid in line_points){for(var from in line_points[fid]){var start_ids=from.split("_");var info=line_points[fid][from];var sib_anchor_pos=null;if(start_ids.length===1){var from_gfx_pos=unique_graph_objs[fid].nodes[from].graphics.getPosition();if(info.drop===null){var to_id=info.to,to_gfx_pos=unique_graph_objs[fid].nodes[to_id].graphics.getPosition();haplo_group_lines.add(addRLine_simple(from_gfx_pos,to_gfx_pos,info.consang));}else{sib_anchor_pos={x:from_gfx_pos.x,y:from_gfx_pos.y+info.drop/3};haplo_group_lines.add(addRLine_simple(from_gfx_pos,sib_anchor_pos,false));}}else{var parent1_id=start_ids[0],parent2_id=start_ids[1];var parent1_gfx=unique_graph_objs[fid].nodes[parent1_id].graphics.getPosition(),parent2_gfx=unique_graph_objs[fid].nodes[parent2_id].graphics.getPosition();var mid_point_pos={x:(parent1_gfx.x+parent2_gfx.x)/2,y:parent1_gfx.y};sib_anchor_pos={x:mid_point_pos.x,y:mid_point_pos.y+info.drop/3};haplo_group_lines.add(addRLine_simple(mid_point_pos,sib_anchor_pos,false));}if(sib_anchor_pos!==null){var sib_ids=info.to.split("_");var min_x_of_sibgroup=99999999999,y_pos_of_any_sibline=999999999;for(var s=0;s<sib_ids.length;s++){var sib_id=sib_ids[s],sib_gfx_pos=unique_graph_objs[fid].nodes[sib_id].graphics.getPosition();var sibline=null;if(!info.lastgen){sibline=addRLine_nonoverlapY(sib_anchor_pos,sib_gfx_pos,false);}else{sibline=addRLine_simple(sib_anchor_pos,sib_gfx_pos,false);}haplo_group_lines.add(sibline);if(sib_gfx_pos.x<min_x_of_sibgroup){min_x_of_sibgroup=sib_gfx_pos.x;y_pos_of_any_sibline=sibline.getPoints()[3];}}if(info.text>1){haplo_group_lines.add(new Kinetic.Circle({x:((sib_anchor_pos.x+min_x_of_sibgroup)/2),y:y_pos_of_any_sibline,radius:6,fill:"white",stroke:"black",strokeWidth:1}));haplo_group_lines.add(new Kinetic.Text({x:((sib_anchor_pos.x+min_x_of_sibgroup)/2)-3,y:y_pos_of_any_sibline-5,text:info.text,fontSize:11,fill:"black"}));}}}}main_layer.draw();haplo_layer.draw();}var haplomode_alignment_toggle=false;function alignTopSelection(group_nodes,group_lines){haplomode_alignment_toggle=!haplomode_alignment_toggle;var tween_array=[];if(haplomode_alignment_toggle){group_lines.hide();var y_line=min_node_placement_y+initial_group_node_offset.y;for(var g=0;g<group_nodes.children.length;g++){var nd=group_nodes.children[g];nd.old_ypos=nd.getY();tween_array.push(kineticTween({node:nd,x:nd.getX(),y:y_line}));}haplo_window.top.rect.old_height=haplo_window.top.rect.getHeight();tween_array.push(kineticTween({node:haplo_window.top.rect,height:white_margin*3}));if(haplo_window.bottom!==undefined){haplo_window.bottom.old_ypos=haplo_window.bottom.getY();tween_array.push(kineticTween({node:haplo_window.bottom,y:(white_margin*3)+haplo_window.y_margin}));}}else{var render_counter=group_nodes.children.length-1;for(var g=0;g<group_nodes.children.length;g++){var nd=group_nodes.children[g];tween_array.push(kineticTween({node:nd,x:nd.getX(),y:nd.old_ypos,onFinish:function(){if(render_counter--===0){group_lines.show();}}}));}tween_array.push(kineticTween({node:haplo_window.top.rect,height:haplo_window.top.rect.old_height}));if(haplo_window.bottom!==undefined){tween_array.push(kineticTween({node:haplo_window.bottom,y:haplo_window.bottom.old_ypos}));}}for(var t=0;t<tween_array.length;){tween_array[t++].play();}}var selection_items={},toggle_selection_affecteds=false,select_group,select_button=addButton("Select Mode",0,0,function(){startSelectionMode();});main_layer.add(select_button);function selectFam(fam_id){for(var key in selection_items){if(key.split("_")[0]==fam_id){selection_items[key].box.fire("click");}}}function stopSelectionMode(){select_group.destroyChildren();select_group.destroy();toggle_selection_affecteds=false;selection_items={};selected_ids_map={};selected_ids={};select_button=addButton("Selection",0,0,function(){startSelectionMode();});main_layer.add(select_button);if(markerInstance!==null){markerInstance.remove();mscale_layer.draw();}haplo_layer.draw();main_layer.draw();}function startSelectionMode(){select_button.destroy();select_group=new Kinetic.Group({x:0,y:0,width:stage.getWidth(),height:stage.getHeight()});select_group.add(new Kinetic.Rect({x:0,y:0,width:stage.getWidth(),height:stage.getHeight(),fill:"black",strokeWidth:0,opacity:0.1}));select_group.add(addButton("Select Affecteds",0,0,function(){toggle_selection_affecteds=!toggle_selection_affecteds;for(var key in selection_items){var item=selection_items[key];var affected=(item.graphics.children[0].attrs.fill===col_affs[2]);if(affected){if((toggle_selection_affecteds&&!item.selected)||(!toggle_selection_affecteds&&item.selected)){item.box.fire("click");}}}console.log("affecteds:",Object.keys(selection_items).filter(function(n){return selection_items[n].affected===true;}));},false));select_group.add(addButton("Submit / Close",0,butt_h,launchHaplomode));function addBounder(pos,key){var border_offs=3;var rect=new Kinetic.Rect({x:pos.x-nodeSize-border_offs,y:pos.y-nodeSize-border_offs,width:(nodeSize*2)+2*border_offs,height:(nodeSize*2)+2*border_offs,strokeAlpha:0.5,strokeWidth:3,strokeEnabled:false,stroke:"orange"});rect.on("click",function(){this.setStrokeEnabled(!selection_items[key].selected);selection_items[key].selected=!selection_items[key].selected;main_layer.draw();});return rect;}for(var fid in unique_graph_objs){for(var node in unique_graph_objs[fid].nodes){if(node==0){continue;}var key=fid+"_"+node;var gfx=unique_graph_objs[fid].nodes[node].graphics,pos=gfx.getAbsolutePosition(),bounder=addBounder(pos,key);selection_items[key]={box:bounder,selected:false,graphics:gfx};select_group.add(bounder);}}main_layer.add(select_group);select_group.setZIndex(20);main_layer.draw();}var selected_ids_map={},selected_ids={};var haplo_window=new Kinetic.Group();haplo_window.top=new Kinetic.Group(),haplo_window.bottom;var min_node_placement_y=0;var left_margin_x=100;var white_margin=20;function stopHaplomode(){toggleBottomBox(false,function(){for(var fid in selected_ids){for(var id in selected_ids[fid]){var perc_gfx=unique_graph_objs[fid].nodes[id].graphics;var old_pos=perc_gfx.main_layer_pos;var old_group=perc_gfx.main_layer_group;perc_gfx.remove();old_group.add(perc_gfx);perc_gfx.setPosition({x:perc_gfx.getX()-old_group.getX(),y:perc_gfx.getY()-old_group.getY()});(kineticTween({node:perc_gfx,x:old_pos.x,y:old_pos.y})).play();}}haplo_layer.destroyChildren();haplo_layer.draw();stopSelectionMode();});}function launchHaplomode(){function grabSelecteds(){var idmap={};var pure_ids={};for(var fam_pid in selection_items){var item=selection_items[fam_pid];if(!item.selected){continue;}var fam=fam_pid.split("_")[0],pid=fam_pid.split("_")[1];if(!(fam in idmap)){idmap[fam]={};pure_ids[fam]={};}pure_ids[fam][pid]=1;var generation=item.graphics.getY();idmap[fam][generation]=idmap[fam][generation]||[];idmap[fam][generation].push(pid);}for(var fam in idmap){idmap[fam]=map2orderedArray(idmap[fam]);}return{id_map_generational:idmap,id_map:pure_ids};}var selecteds=grabSelecteds();selected_ids_map=selecteds.id_map_generational;selected_ids=selecteds.id_map;console.log(selected_ids,selected_ids);if(isEmpty(selected_ids)){return stopSelectionMode();}var line_data=findDOSinSelection(selected_ids_map);makeHaploTypeWindow(line_data);}function makeHaploTypeWindow(lines_nodes_to_render){var res=mapLinesAndNodes(lines_nodes_to_render);var line_points=res.lp,slot_array=res.sa;haplo_layer.add(haplo_window);haplo_window.background=new Kinetic.Rect({width:window.innerWidth,height:window.innerHeight,fill:"black",opacity:0.5});haplo_window.add(haplo_window.background);var min_pos,max_pos;var box_lims_and_group=render(line_points,slot_array,function(render_group){makeTopBox_haplomode(box_lims_and_group,render_group);});}function makeTopBox_haplomode(box_lims_and_group,render_group){min_pos=box_lims_and_group.min,max_pos=box_lims_and_group.max;min_node_placement_y=min_pos.y;haplo_window.top.setPosition({x:initial_group_node_offset.x+(min_pos.x-white_margin),y:initial_group_node_offset.y+(min_pos.y-white_margin)});haplo_window.top.rect=addWhiteRect({width:(max_pos.x-min_pos.x),height:(max_pos.y-min_pos.y)+3*white_margin});haplo_window.top.add(haplo_window.top.rect);haplo_window.top.add(addExitButton({x:max_pos.x-white_margin,y:0},stopHaplomode));haplo_window.add(addButton("Align Pedigree",0,0,function(){alignTopSelection(haplo_group_nodes,haplo_group_lines);}));render_group.remove();haplo_window.top.add(render_group);render_group.setY(-haplo_window.top.getY());render_group.setX(-haplo_window.top.getX()+10);haplo_window.add(haplo_window.top);(new Kinetic.Tween({node:haplo_window.top,x:left_margin_x,y:white_margin,duration:0.2,onFinish:function(){toggleBottomBox(true);}})).play();main_layer.draw();haplo_layer.draw();}function toggleBottomBox(show,finishfunc){finishfunc=finishfunc||0;console.log(finishfunc);haplo_window.y_margin=30;console.log("sel_ids=",selected_ids_map);var toggle_zoommarkers=false;if(show){delete haplo_window.bottom;haplo_window.zoom_button=addButton("Range Slider",0,butt_h,function(){toggle_zoommarkers=!toggle_zoommarkers;console.log("zooming",toggle_zoommarkers);var marker_slid=getSlider(window.innerWidth-100,60);if(toggle_zoommarkers){mscale_layer.add(marker_slid);updateInputsByIndex(0,HAP_DRAW_LIM);updateSlide();}else{marker_slid.remove();}mscale_layer.draw();});haplo_window.add(haplo_window.zoom_button);haplo_window.bottom=new Kinetic.Group({x:haplo_window.top.getX(),y:haplo_window.top.rect.getHeight()+haplo_window.y_margin,id:"scroll_panel"});haplo_window.bottom.rect=addWhiteRect({height:0,width:haplo_window.top.rect.getWidth()});haplo_window.bottom.add(haplo_window.bottom.rect);haplo_window.add(haplo_window.bottom);haplo_window.bottom.setZIndex(-2);kineticTween({node:haplo_window.bottom.rect,height:(3+HAP_DRAW_LIM)*HAP_VERT_SPA,onFinish:function(){var scroll_area__=new Kinetic.Group({draggable:true,dragBoundFunc:function(pos){var group_loc=this.parent.getAbsolutePosition();return{x:group_loc.x,y:group_loc.y+(Math.floor((pos.y-group_loc.y)/HAP_VERT_SPA)*HAP_VERT_SPA)};}});scroll_area__.on("mouseup",function(){redrawHaplos(false);updateInputsByIndex(sta_index,end_index);updateSlide();mscale_layer.draw();});unique_graph_objs.haplo_scroll=haplo_window.bottom;unique_graph_objs.haplo_area=scroll_area__;haplo_window.bottom.add(scroll_area__);addHaplosAnyone(selected_ids);unique_graph_objs.parent.show();if(finishfunc!==0){finishfunc();}}}).play();}else{haplo_window.zoom_button.destroy();delete haplo_window.zoom_button;unique_graph_objs.haplo_area.hide();kineticTween({node:haplo_window.bottom.rect,height:0,onFinish:function(){haplo_window.bottom.destroyChildren();haplo_window.bottom.destroy();if(finishfunc!==0){finishfunc();}}}).play();}haplo_layer.draw();}function removeAmbiguousPointers(fam){for(var g=0;g<generation_grid_ids[fam].length;g++){for(var p=0;p<generation_grid_ids[fam][g].length;p++){var id=generation_grid_ids[fam][g][p];var both_alleles=family_map[fam][id].haplo_data;for(var a=0;a<both_alleles.length;a++){var pointer_array=both_alleles[a].pter_array;var group_array=(both_alleles[a].haplogroup_array=new Int8Array(pointer_array.length));var curr_index=-1;while(++curr_index<pointer_array.length){group_array[curr_index]=pointer_array[curr_index].color_group[0];}delete both_alleles[a].pter_array;}}}}var a_star_bestfirst__DEBUG=function(array,exclude_list){var inExcludeList;if(exclude_list===undefined||exclude_list.length===0){inExcludeList=function(item){return false;};}else{if((typeof exclude_list)==="number"){inExcludeList=function(item){return item===exclude_list;};}else{if(exclude_list.length===1){exclude_list=exclude_list[0];inExcludeList=function(item){return item===exclude_list;};}else{inExcludeList=function(item){return(exclude_list.indexOf(item)!==-1);};}}}var end=array.length-1;var MAX_ROUTES=4;var exploring_routes=[{array:[],numsets:0}],complete_routes=[];var route_map={};var num_cycles=0;var stretches_only=true;while(true){while(exploring_routes.length!==0){num_cycles++;exploring_routes=exploring_routes.sort(function(a,b){return b.array.length-a.array.length;}).slice(0,MAX_ROUTES);var current_route=exploring_routes[0].array,current_nsets=exploring_routes[0].numsets,current_row=current_route.length;var num_colors=array[current_row].color_group.length;console.log("Route:",current_route);console.log("    current_row="+current_row);console.log("    num_colors =",num_colors);var ordered_routes={},zero_indexes={};for(var c=0;c<num_colors;c++){var current_color=array[current_row].color_group[c];console.log("    - trying color "+current_color);if(inExcludeList(current_color)){console.log("    - EXCLUDE!");continue;}var stretch=current_row+1;while(stretch<=end){var new_colors=array[stretch].color_group;console.log("       - testing "+current_color+" against "+new_colors+" @i "+stretch);if(new_colors.indexOf(current_color)===-1){if(new_colors.length===1&&new_colors[0]===zero_color_grp){zero_indexes[stretch]=0;}else{break;}}stretch++;}stretch-=current_row;console.log("    - stretches for ",stretch,"before index",stretch+current_row);ordered_routes[stretch]=current_color;}var keys_rev_ord=Object.keys(ordered_routes).sort(function(a,b){return b-a;});console.log("    ordered_routes=",ordered_routes);console.log("    reversed_order=",keys_rev_ord);for(var k=0;k<keys_rev_ord.length;k++){var key=keys_rev_ord[k];if(stretches_only&&key<=1){console.log("    dead_end route, skipping");continue;}var new_r=current_route.slice();var len=key;while(len-->0){new_r.push(ordered_routes[key]);}console.log("   - adding '"+ordered_routes[key]+"' "+key+"x  to ",new_r);for(var z_index in zero_indexes){if(new_r.length>z_index){new_r[z_index]=zero_color_grp;}}var new_pack={array:new_r,numsets:current_nsets+1};var string_key=new_r.reduce(function(a,b){return a+""+b;});if(!(string_key in route_map)){route_map[string_key]=0;if(new_r.length===array.length){complete_routes.push(new_pack);}else{exploring_routes.push(new_pack);}}}exploring_routes.splice(0,1);zero_indexes={};console.log("    explored="+exploring_routes.map(function(n){return"["+n.array+"] ";}));console.log("    complete="+complete_routes.map(function(n){return"["+n.array+"] ";}));}if(complete_routes.length===0){if(stretches_only){stretches_only=false;console.log("repeating without stretches");complete_routes=[];exploring_routes=[{array:[],numsets:0}];route_map={};continue;}return null;}break;}var best;if(complete_routes.length===1){best=complete_routes[0].array;}else{best=complete_routes.sort(function(a,b){return a.numsets-b.numsets;})[0].array;}console.log("best_routes A*",complete_routes);console.log(" with best=",best);console.log("  in "+num_cycles+" cycles");console.log("SRC ARRAY=",array.map(function(a){return""+a.color_group+"";}));return best;};var starbest_body=(function(){var entire=a_star_bestfirst__DEBUG.toString();return entire.slice(entire.indexOf("{")+1,entire.lastIndexOf("}"));})();var strre=starbest_body.replace(/console\.log\(.*\)\;/g,"");var a_star_bestfirst=new Function("array","exclude_list",strre);var hgroup_colors=[],unique_colors=[];var zero_color_grp=-1;var uniqueset=function(set){return set.filter(function(item,i,ar){return(item!==zero_color_grp&&ar.indexOf(item)===i);});};function initFounderAlleles(fid,id){var perc_hdata=family_map[fid][id].haplo_data;for(var a=0;a<perc_hdata.length;a++){var color_group=hgroup_colors.length;hgroup_colors.push(id);var allele_ptrs=perc_hdata[a].pter_array;for(var i=0;i<allele_ptrs.length;i++){allele_ptrs[i].color_group=[color_group];}allele_ptrs.unique_groups=[color_group];}}function pushAll(from,to){for(var j=0;j<from.color_group.length;j++){if(to.color_group.indexOf(from.color_group[j])==-1){to.color_group.push(from.color_group[j]);}}}function debugHaploData(dat){return{0:dat[0].debug(),1:dat[1].debug()};}function child2parent_link(pers,moth,fath,fam){var pers_hp=pers.haplo_data,moth_hp=moth.haplo_data,fath_hp=fath.haplo_data,gender=pers.gender;assert(pers_hp[0].data_array.length===moth_hp[0].data_array.length&&pers_hp[0].data_array.length===fath_hp[0].data_array.length&&pers_hp[1].data_array.length===moth_hp[1].data_array.length&&pers_hp[1].data_array.length===fath_hp[1].data_array.length,"Allele lengths dont match");var tmp_i=-1;while(++tmp_i<pers_hp[0].data_array.length){var f0_ht=fath_hp[0].data_array[tmp_i],f1_ht=fath_hp[1].data_array[tmp_i],m0_ht=moth_hp[0].data_array[tmp_i],m1_ht=moth_hp[1].data_array[tmp_i];var f0_pr=fath_hp[0].pter_array[tmp_i],f1_pr=fath_hp[1].pter_array[tmp_i],m0_pr=moth_hp[0].pter_array[tmp_i],m1_pr=moth_hp[1].pter_array[tmp_i];if(f0_ht===0){f0_pr.color_group=[zero_color_grp];}if(f1_ht===0){f1_pr.color_group=[zero_color_grp];}if(m0_ht===0){m0_pr.color_group=[zero_color_grp];}if(m1_ht===0){m1_pr.color_group=[zero_color_grp];}var c0_ht=pers_hp[0].data_array[tmp_i],c1_ht=pers_hp[1].data_array[tmp_i];var c0_pr=pers_hp[0].pter_array[tmp_i],c1_pr=pers_hp[1].pter_array[tmp_i];if(c0_pr.color_group.length!==0){console.log("c0_pr not [], for "+pers.id+" @ "+tmp_i,c0_pr);throw new Error("");}if(c1_pr.color_group.length!==0){console.log("c1_pr not [], for "+pers.id+" @ "+tmp_i,c1_pr);throw new Error("");}if(SEXLINKED&&gender===1){pushAll(f1_pr,c1_pr);if(c0_ht===m0_ht){pushAll(m0_pr,c0_pr);}if(c0_ht===m1_ht){pushAll(m1_pr,c0_pr);}continue;}function resetCheck(p1,p2){var reset=(p1.color_group.length===0||p2.color_group.length===0);if(reset){p1.color_group=[];p2.color_group=[];}}if(c0_ht===f0_ht){pushAll(f0_pr,c0_pr);if(c1_ht===m0_ht){pushAll(m0_pr,c1_pr);}if(c1_ht===m1_ht){pushAll(m1_pr,c1_pr);}}resetCheck(c0_pr,c1_pr);if(c0_ht===f1_ht){pushAll(f1_pr,c0_pr);if(c1_ht===m0_ht){pushAll(m0_pr,c1_pr);}if(c1_ht===m1_ht){pushAll(m1_pr,c1_pr);}}resetCheck(c0_pr,c1_pr);if(c0_ht===m0_ht){pushAll(m0_pr,c0_pr);if(c1_ht===f0_ht){pushAll(f0_pr,c1_pr);}if(c1_ht===f1_ht){pushAll(f1_pr,c1_pr);}}resetCheck(c0_pr,c1_pr);if(c0_ht===m1_ht){pushAll(m1_pr,c0_pr);if(c1_ht===f0_ht){pushAll(f0_pr,c1_pr);}if(c1_ht===f1_ht){pushAll(f1_pr,c1_pr);}}resetCheck(c0_pr,c1_pr);}console.log("Ci",pers.id,debugHaploData(pers_hp));var maternal_exclusion=moth_hp[0].unique_groups.concat(moth_hp[1].unique_groups),paternal_exclusion=fath_hp[0].unique_groups.concat(fath_hp[1].unique_groups);var key="m:"+fath.id+"-"+moth.id;var consang_check=unique_graph_objs[fam].edges[key].consangineous;if(consang_check){var toKick=[];for(var ov1=0;ov1<maternal_exclusion.length;ov1++){for(var ov2=0;ov2<paternal_exclusion.length;ov2++){if(maternal_exclusion[ov1]===paternal_exclusion[ov2]){toKick.push(maternal_exclusion[ov1]);}}}if(toKick.length!==0){for(var tk=0;tk<toKick.length;tk++){var val=toKick[tk];var maternal_index=maternal_exclusion.indexOf(val),paternal_index=paternal_exclusion.indexOf(val);maternal_exclusion.splice(maternal_index,1);paternal_exclusion.splice(paternal_index,1);}}}var res0=a_star_bestfirst(pers_hp[0].pter_array,maternal_exclusion),res1;if(res0===null){res0=a_star_bestfirst(pers_hp[0].pter_array,paternal_exclusion);if(res0===null){throw new Error("Skipper's Log: No land in sight.");}res1=a_star_bestfirst(pers_hp[1].pter_array,maternal_exclusion);}res1=a_star_bestfirst(pers_hp[1].pter_array,paternal_exclusion);if(res1===null){res0=a_star_bestfirst(pers_hp[0].pter_array,paternal_exclusion);res1=a_star_bestfirst(pers_hp[1].pter_array,maternal_exclusion);if(res0===null||res1===null){throw new Error("Skipper's Log: It's been days...");}}var unique0=res0.filter(function(item,i,ar){return(item!==zero_color_grp&&ar.indexOf(item)===i);});var unique1=res1.filter(function(item,i,ar){return(item!==zero_color_grp&&ar.indexOf(item)===i);});pers_hp[0].unique_groups=unique0;pers_hp[1].unique_groups=unique1;var curr_index=-1;while(++curr_index<res0.length){pers_hp[0].pter_array[curr_index].color_group=[res0[curr_index]];pers_hp[1].pter_array[curr_index].color_group=[res1[curr_index]];}console.log("Cf",pers.id,debugHaploData(pers_hp));}var hsv2rgb=function(h,s,v){var rgb,i,data=[];if(s===0){rgb=[v,v,v];}else{h=h/60;i=Math.floor(h);data=[v*(1-s),v*(1-s*(h-i)),v*(1-s*(1-(h-i)))];switch(i){case 0:rgb=[v,data[2],data[0]];break;case 1:rgb=[data[1],v,data[0]];break;case 2:rgb=[data[0],v,data[2]];break;case 3:rgb=[data[0],data[1],v];break;case 4:rgb=[data[2],data[0],v];break;default:rgb=[v,data[0],data[1]];break;}}return"#"+rgb.map(function(x){return("0"+Math.round(x*255).toString(16)).slice(-2);}).join("");};function makeUniqueColors(){var num_colors=hgroup_colors.length,step_color=(Math.floor(360/(num_colors)));var sat=33,val=51,hue=0;for(var c=0;c<num_colors;c++){unique_colors[c]=hsv2rgb(hue,sat,val);hue+=step_color;}}function assignHGroups(){for(var fam in generation_grid_ids){var founder_gen=generation_grid_ids[fam][0];for(var p=0;p<founder_gen.length;p++){initFounderAlleles(fam,founder_gen[p]);}for(var g=1;g<generation_grid_ids[fam].length;g++){for(var p=0;p<generation_grid_ids[fam][g].length;p++){var pers_id=generation_grid_ids[fam][g][p],pers=family_map[fam][pers_id];var moth_id=pers.mother.id,fath_id=pers.father.id;if(moth_id==undefined){initFounderAlleles(fam,pers_id);continue;}var moth=family_map[fam][moth_id],fath=family_map[fam][fath_id];child2parent_link(pers,moth,fath,fam);}}console.log("hgroups fam ="+fam);removeAmbiguousPointers(fam);}makeUniqueColors();}var sta_index=0,end_index=HAP_DRAW_LIM;var haploinfos;function addHaplosAnyone(haplofam_map,parent_node){haploinfos=[];for(var fid in haplofam_map){for(var pid in haplofam_map[fid]){var pers_hp=family_map[fid][pid].haplo_data;haploinfos.push(pers_hp);}}redrawHaplos(true);}function addHaplosFamily(fam,parent_node){haploinfos=[];for(var g=0;g<generation_grid_ids[fam].length;g++){for(var p=0;p<generation_grid_ids[fam][g].length;p++){var pers_id=generation_grid_ids[fam][g][p],pers_hp=family_map[fam][pers_id].haplo_data;haploinfos.push(pers_hp);}}redrawHaplos(true);}function redrawHaplos(resizeToo){var scroll_rect=unique_graph_objs.haplo_scroll,scroll_area=unique_graph_objs.haplo_area;var diff_y=scroll_rect.getAbsolutePosition().y-scroll_area.getAbsolutePosition().y,index_start_delta=Math.floor(diff_y/HAP_VERT_SPA);sta_index+=index_start_delta;end_index+=index_start_delta;scroll_area.destroyChildren();scroll_area.setY(0);if(sta_index<0){sta_index=0;end_index=HAP_DRAW_LIM;}if(end_index>marker_array.length-1){end_index=marker_array.length-1;sta_index=end_index-HAP_DRAW_LIM;}var new_haplos=addHaploBlocksAll();scroll_area.add(new_haplos);scroll_area.parent.show();haplo_layer.draw();if(resizeToo){resizeCanvas();}}var show_marker_map=false,slider_glob;function toggleRAng(){use_right_angles=!use_right_angles;touchlines();main_layer.draw();}function playalong(){assignHGroups();addHaplos();}function toggleMarkerScale(){show_marker_map=!show_marker_map;if(show_marker_map){slider_glob=makeSlider(10,100);haplo_layer.add(slider_glob);updateInputsByIndex(0,HAP_DRAW_LIM);updateSlide();rangeline_pos=slwin_group.line.getAbsolutePosition();haplo_layer.draw();}else{slider_glob.destroy();}}var Allele=function(data){this.data_array=new Int8Array(data);this.pter_array=[];for(var i=0;i<data.length;i++){this.pter_array.push({color_group:[]});}this.haplogroup_array;this.unique_groups=[];};Allele.prototype.debug=function(){return{data:this.data_array,groups:(this.pter_array.map(function(n){return""+n.color_group+"";})),unique:this.unique_groups};};function washMarkerMap(){var maxlen=0;for(var i=0;i<marker_array.length;i++){var len=marker_array[i].length;if(len>maxlen){maxlen=len;}}var format=(function(){var m=maxlen,tx="";while(m-->0){tx+=" ";}return tx;})();maxlen=10;maxlen_marker=maxlen;for(var i=0;i<marker_array.length;i++){marker_array[i]=(marker_array[i]+format).slice(0,maxlen);}}function processInput(text_unformatted,type){var text=text_unformatted.split("\n");var num_alleles_markers=-1;if(type==="allegro"){var header_lines=[],start_extract=-1;function handleHeaders(){var count_markers=0;for(var col=start_extract;col<header_lines[0].length;col++){var col_string="";for(var row=header_lines.length;row>0;){col_string+=header_lines[--row][col];}col_string=col_string.trim();if(col_string!==""){marker_array.push(col_string);}}}for(var l=0;l<text.length;l++){var line=text[l];if(line.length<5){continue;}if(line.substr(0,1)===" "){start_extract=line.lastIndexOf("    ")+4;header_lines.push(line);}else{var people_info=line.substring(0,start_extract-1).trim().split(/\s+/).map(toInt),haplo_daaaa=line.substring(start_extract).trim().split(/\s+/).map(toInt),haplo_info=new Allele(haplo_daaaa);var fam=people_info[0],id=people_info[1],pat=people_info[2],mat=people_info[3],sex=people_info[4],aff=people_info[5];if(!(fam in family_map)){family_map[fam]={};}if(!(id in family_map[fam])){var pers=new Person(id,sex,aff,mat,pat);family_map[fam][id]=pers;}family_map[fam][id].haplo_data.push(haplo_info);if(num_alleles_markers===-1){num_alleles_markers=haplo_info.data_array.length;}else{assert(num_alleles_markers==haplo_info.data_array.length,"Number of alleles do not match previous records: Line "+l+"!");}}}handleHeaders();if(marker_array.length-1<HAP_DRAW_LIM){HAP_DRAW_LIM=marker_array.length-1;}}else{if(type==="Other"){}}}function processFile(){var file=document.getElementById("file_upload").files[0],type="allegro";var lr=new FileReader();lr.onloadend=function(e){processInput(e.target.result,type);connectAllIndividuals();populateGrids_and_UniqueObjs();determinePedigreeType();graphInitPos(nodeSize+10,grid_rezY);assignHGroups();washMarkerMap();document.getElementById("buttons").style.display="none";};lr.readAsText(file);}var i_slider_top_y=0,i_slider_length=0;function inputDragFunc(abspos){var perc,rsindex;if(this.isTop){var atstart=false;if(abspos.y>=last_input2_posy){abspos.y=last_input2_posy;}if(abspos.y<=rangeline_pos.y){abspos.y=rangeline_pos.y+1;atstart=true;}last_input1_posy=abspos.y;perc=(abspos.y-rangeline_pos.y)/slider_height;last_input1_ind=rsindex=(atstart?0:Math.floor(perc*marker_array.length));}else{var atend=false;if(abspos.y<=last_input1_posy){abspos.y=last_input1_posy;}if(abspos.y>rangeline_pos.y+slider_height){abspos.y=rangeline_pos.y+slider_height;atend=true;}last_input2_posy=abspos.y;perc=(abspos.y-rangeline_pos.y)/slider_height;last_input2_ind=rsindex=(atend?marker_array.length-1:Math.floor(perc*marker_array.length));}this.message.setText(marker_array[rsindex]);updateSlide();return{x:this.getAbsolutePosition().x,y:abspos.y};}function sliderDragFunc(p){var top_I=p.y-rangeline_pos.y,bot_I=top_I+i_slider_length;if(top_I<0){top_I=0;bot_I=top_I+i_slider_length;}else{if(bot_I>=slider_height){bot_I=slider_height;top_I=bot_I-i_slider_length;}}updateInputsByPos(top_I,bot_I);return{x:this.getAbsolutePosition().x,y:top_I+rangeline_pos.y};}function updateSlide(){var offs=I_slider_offset;i_slider_top_y=last_input1_posy-rangeline_pos.y;i_slider_length=(last_input2_posy-last_input1_posy);var top_slider=[-offs,0],bot_slider=[-offs,i_slider_length];slwin_group.setY(i_slider_top_y);slwin_group.line.setPoints([top_slider[0]+offs*2,top_slider[1],top_slider[0],top_slider[1],bot_slider[0],bot_slider[1],bot_slider[0]+offs*2,bot_slider[1]]);slwin_group.message.setText(last_input2_ind-last_input1_ind);slwin_group.message.setY((i_slider_length/2)-HAP_VERT_SPA/2);}function updateInputsByPos(top,bot){sl_input1.setY(top);sl_input2.setY(bot);last_input1_ind=(top===0)?0:Math.floor(top*marker_array.length/slider_height),last_input2_ind=(bot===slider_height)?marker_array.length-1:Math.floor(bot*marker_array.length/slider_height);sl_input1.message.setText(marker_array[last_input1_ind]);sl_input2.message.setText(marker_array[last_input2_ind]);last_input1_posy=top+rangeline_pos.y;last_input2_posy=bot+rangeline_pos.y;}function updateInputsByIndex(ind1,ind2){last_input1_ind=ind1;last_input2_ind=ind2;var top=(last_input1_ind/marker_array.length)*slider_height,bot=(last_input2_ind/marker_array.length)*slider_height;sl_input1.setY(top);sl_input2.setY(bot);sl_input1.message.setText(marker_array[last_input1_ind]);sl_input2.message.setText(marker_array[last_input2_ind]);last_input1_posy=top+rangeline_pos.y;last_input2_posy=bot+rangeline_pos.y;}function updateHaploPositions(resizecanvastoo){if(!toggle_haplotypes){return;}sta_index=last_input1_ind;end_index=last_input2_ind;HAP_DRAW_LIM=end_index-sta_index;haplo_window.bottom.rect.setHeight((HAP_DRAW_LIM+3)*HAP_VERT_SPA);redrawHaplos(resizecanvastoo);}var markerInstance=null;var last_input1_posy,last_input1_ind,last_input2_posy,last_input2_ind,rangeline_pos;var slwin_group,sl_input1,sl_input2;function getSlider(xer,yer){if(markerInstance!==null){return markerInstance;}function makeInputSlider(top){var input_group=new Kinetic.Group({x:0,y:0,draggable:true,dragBoundFunc:inputDragFunc});var mark_label=new Kinetic.Text({x:I_slider_offset*2,y:(top?-I_slider_extension:I_slider_extension)-HAP_VERT_SPA/2,text:"",fontFamily:"Arial",fontSize:10,fill:"black"});var line_out=new Kinetic.Line({points:[I_slider_offset,0,I_slider_offset,top?-I_slider_extension:I_slider_extension,I_slider_offset*2,top?-I_slider_extension:I_slider_extension],stroke:slider_style.I_stroke,strokeWidth:slider_style.I_strokeWidth});input_group.on("mouseup",function(){updateHaploPositions(true);});input_group.add(mark_label);input_group.add(line_out);input_group.message=mark_label;input_group.isTop=top;return input_group;}var marker_slider=new Kinetic.Group({x:xer,y:yer,draggable:true});markerInstance=marker_slider;var rangeline=new Kinetic.Line({x:0,y:0,stroke:slider_style.R_stroke,strokeWidth:slider_style.R_strokeWidth,lineCap:slider_style.R_cap,points:[0,0,0,slider_height]});rangeline.on("mouseup",function(e){rangeline_pos=this.getAbsolutePosition();last_input1_posy=sl_input1.getAbsolutePosition().y;last_input2_posy=sl_input2.getAbsolutePosition().y;});slwin_group=new Kinetic.Group({draggable:true,dragBoundFunc:sliderDragFunc});slwin_group.on("mousedown",function(){haplo_layer.disableHitGraph();});slwin_group.on("dragmove",function(){if(HAP_DRAW_LIM<HAP_MIN_DRAW){updateHaploPositions();}});slwin_group.on("mouseup",function(){haplo_layer.enableHitGraph();updateHaploPositions();});var slwin_lin=new Kinetic.Line({x:0,y:0,stroke:slider_style.I_stroke,strokeWidth:slider_style.I_strokeWidth,points:[0,0,0,slider_height]}),slwin_tex=new Kinetic.Text({x:slideinp_w/2,y:slider_height/2,text:"win",fontFamily:slider_style.I_fontFamily,fontSize:slider_style.I_fontSize,fill:slider_style.I_fontColor});slwin_group.add(slwin_lin);slwin_group.add(slwin_tex);slwin_group.line=slwin_lin;slwin_group.message=slwin_tex;sl_input1=makeInputSlider(true),sl_input2=makeInputSlider(false);sl_input2.setY(slider_height);rangeline_pos={x:xer,y:yer};last_input1_posy=yer;last_input2_posy=yer+slider_height;marker_slider.add(rangeline);marker_slider.add(sl_input1);marker_slider.add(sl_input2);marker_slider.add(slwin_group);return marker_slider;}function resizeCanvas(){stage.setWidth(window.innerWidth);var new_height=((HAP_DRAW_LIM+5)*HAP_VERT_SPA)+200;if(new_height<window.innerHeight){new_height=window.innerHeight;}stage.setHeight(new_height);haplo_window.background.setWidth(window.innerWidth);haplo_window.background.setHeight(new_height);haplo_layer.draw();}
</script>









</body>
</html>
